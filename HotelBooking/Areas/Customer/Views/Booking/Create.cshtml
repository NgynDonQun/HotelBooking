@{
    ViewBag.Title = "Đặt phòng";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container py-4">
    <h2 class="mb-4">Đặt phòng</h2>

    <div class="row">
        <div class="col-md-8">
            <div class="card mb-3 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0 text-primary">Thông tin đặt phòng</h5>
                </div>
                <div class="card-body">
                    <form id="bookingForm">
                        <input type="hidden" id="hotelId" value="@ViewBag.HotelId" />
                        <input type="hidden" id="roomId" value="@ViewBag.RoomId" />

                        <div id="error-message" class="alert alert-danger" style="display:none;"></div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="checkInDate" class="form-label fw-bold">Ngày nhận phòng</label>
                                <input type="date" class="form-control" id="checkInDate" required />
                            </div>
                            <div class="col-md-6">
                                <label for="checkOutDate" class="form-label fw-bold">Ngày trả phòng</label>
                                <input type="date" class="form-control" id="checkOutDate" required />
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="guests" class="form-label fw-bold">Số khách (Tối đa <span id="maxCapacity">2</span>)</label>
                            <input type="number" class="form-control" id="guests" value="1" min="1" required />
                        </div>

                        <div class="mb-3">
                            <label for="note" class="form-label fw-bold">Yêu cầu đặc biệt</label>
                            <textarea class="form-control" id="note" rows="3" placeholder="Ví dụ: Nhận phòng trễ, giường đôi..."></textarea>
                        </div>

                        <button type="submit" class="btn btn-primary btn-lg w-100 mt-3">
                            Tiếp tục thanh toán <i class="fas fa-arrow-right"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm sticky-top" style="top: 20px;">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Tóm tắt</h5>
                </div>
                <div class="card-body" id="bookingSummary">
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        // Lấy ID từ ViewBag (được set trong Controller action Create)
        var roomId = parseInt($("#roomId").val());
        var hotelId = parseInt($("#hotelId").val());
        var roomPrice = 0;

        $(document).ready(function () {
            // Setup Datepicker limits
            var today = new Date().toISOString().split('T')[0];
            $("#checkInDate").attr('min', today).val(today);

            var tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            var tomorrowStr = tomorrow.toISOString().split('T')[0];
            $("#checkOutDate").attr('min', tomorrowStr).val(tomorrowStr);

            loadRoomInfo();

            $("#checkInDate, #checkOutDate").change(function () {
                // Logic ràng buộc ngày
                if (this.id === 'checkInDate') {
                    $("#checkOutDate").attr('min', $(this).val());
                }
                updateSummary();
            });

            $("#bookingForm").submit(function (e) {
                e.preventDefault();
                createBooking();
            });
        });

        function loadRoomInfo() {
            $.ajax({
                type: "GET",
                url: '/Customer/Booking/GetRoomInfo',
                data: { roomId: roomId, hotelId: hotelId },
                success: function (response) {
                    if (response.success) {
                        roomPrice = response.room.PricePerNight;
                        // Update Max Capacity
                        $("#guests").attr('max', response.room.Capacity);
                        $("#maxCapacity").text(response.room.Capacity);

                        // Render Summary ban đầu
                        // Chú ý: response.room.Type là VIP/Normal, RoomNumber là số phòng
                        var typeLabel = response.room.Type === 'VIP' ? 'VIP' : 'Thường';

                        var html = `
                                <h6 class="text-primary fw-bold">${response.hotel.Name}</h6>
                                <hr/>
                                <p class="mb-1"><strong>Phòng:</strong> ${response.room.RoomNumber}</p>
                                <p class="mb-1"><strong>Loại:</strong> ${typeLabel}</p>
                                <p class="mb-1"><strong>Sức chứa:</strong> ${response.room.Capacity} người</p>
                                <p class="mb-3"><strong>Giá:</strong> ${roomPrice.toLocaleString()} ₫/đêm</p>
                                <div id="priceCalculation"></div>
                            `;
                        $("#bookingSummary").html(html);
                        updateSummary();
                    } else {
                        alert(response.message);
                        window.history.back();
                    }
                }
            });
        }

        function updateSummary() {
            var checkIn = new Date($("#checkInDate").val());
            var checkOut = new Date($("#checkOutDate").val());

            if (checkOut <= checkIn) {
                $("#priceCalculation").html('<p class="text-danger small">Ngày trả phòng phải sau ngày nhận phòng</p>');
                return;
            }

            var timeDiff = checkOut - checkIn;
            var nights = Math.ceil(timeDiff / (1000 * 3600 * 24));

            if (nights > 0 && roomPrice > 0) {
                var total = roomPrice * nights;
                var html = `
                        <div class="bg-light p-2 rounded">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Số đêm:</span>
                                <span>${nights}</span>
                            </div>
                            <div class="d-flex justify-content-between mb-1">
                                <span>Tạm tính:</span>
                                <span>${total.toLocaleString()} ₫</span>
                            </div>
                            <hr class="my-2"/>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-bold">Tổng cộng:</span>
                                <span class="text-danger fw-bold h5 mb-0">${total.toLocaleString()} ₫</span>
                            </div>
                        </div>
                    `;
                $("#priceCalculation").html(html);
            }
        }

        function createBooking() {
            var guests = parseInt($("#guests").val());
            var maxGuests = parseInt($("#guests").attr('max'));

            if (guests > maxGuests) {
                $("#error-message").text(`Phòng này chỉ chứa tối đa ${maxGuests} người.`).show();
                return;
            }

            var formData = {
                HotelId: hotelId,
                RoomId: roomId,
                CheckInDate: $("#checkInDate").val(),
                CheckOutDate: $("#checkOutDate").val(),
                Guests: guests,
                Note: $("#note").val()
            };

            var btn = $("button[type=submit]");
            var originalText = btn.html();
            btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Đang xử lý...');

            $.ajax({
                type: "POST",
                url: '/Customer/Booking/CreateBooking',
                data: JSON.stringify(formData),
                contentType: "application/json; charset=utf-8",
                success: function (response) {
                    if (response.success) {
                        window.location.href = '/Customer/Booking/Payment/' + response.bookingId;
                    } else {
                        $("#error-message").text(response.message).show();
                        btn.prop('disabled', false).html(originalText);
                    }
                },
                error: function () {
                    $("#error-message").text("Đã xảy ra lỗi. Vui lòng thử lại.").show();
                    btn.prop('disabled', false).html(originalText);
                }
            });
        }
    </script>
}