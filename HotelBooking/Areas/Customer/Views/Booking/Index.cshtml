@{
    ViewBag.Title = "Danh sách Booking";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid py-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">Danh sách Booking của tôi</h3>
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="/">Trang chủ</a></li>
            <li class="breadcrumb-item active">Booking</li>
        </ol>
    </div>

    <ul class="nav nav-pills mb-4" id="statusTabs">
        <li class="nav-item">
            <a class="nav-link active" href="#" data-status="">Tất cả</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#" data-status="paid">Đã thanh toán</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#" data-status="pending">Chờ thanh toán</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#" data-status="cancelled">Đã hủy</a>
        </li>
    </ul>

    <div id="bookingsList">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status"></div>
            <p>Đang tải dữ liệu...</p>
        </div>
    </div>
</div>

@section scripts {
    <script>
        var url_domain = window.location.origin;
        var currentFilter = '';

        $(document).ready(function () {
            loadBookings();

            $("#statusTabs .nav-link").click(function (e) {
                e.preventDefault();
                $("#statusTabs .nav-link").removeClass('active');
                $(this).addClass('active');
                currentFilter = $(this).data('status');
                loadBookings();
            });
        });

        function loadBookings() {
            $.ajax({
                type: "GET",
                url: '/Customer/Booking/GetMyBookings',
                success: function (response) {
                    if (response.success) {
                        var bookings = response.data;
                        if (currentFilter) {
                            bookings = bookings.filter(function (b) {
                                return b.Status === currentFilter;
                            });
                        }
                        displayBookings(bookings);
                    } else {
                        $("#bookingsList").html("<p class='alert alert-danger'>" + response.message + "</p>");
                    }
                },
                error: function () {
                    $("#bookingsList").html("<p class='alert alert-danger'>Đã xảy ra lỗi khi tải dữ liệu</p>");
                }
            });
        }

        function displayBookings(bookings) {
            if (bookings.length === 0) {
                $("#bookingsList").html('<div class="alert alert-info text-center py-4"><h5>Chưa có booking nào.</h5><a href="/Search/Index" class="btn btn-primary mt-2">Tìm kiếm khách sạn ngay</a></div>');
                return;
            }

            var html = '';
            bookings.forEach(function (booking) {
                // Update: Hiển thị thêm thông tin Phòng
                var roomInfo = `<span class="badge bg-light text-dark border me-1"><i class="fas fa-door-open"></i> Phòng ${booking.RoomNumber}</span>
                                    <span class="badge bg-light text-dark border">${booking.RoomType === 'VIP' ? 'VIP' : 'Thường'}</span>`;

                html += `
                    <div class="card mb-3 shadow-sm border-start border-4 ${getBorderColor(booking.Status)}">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h5 class="text-primary mb-1"><i class="fas fa-hotel"></i> ${booking.HotelName}</h5>
                                    <div class="mb-2 text-muted small"><i class="fas fa-barcode"></i> ${booking.Code}</div>

                                    <div class="mb-2">${roomInfo}</div>

                                    <p class="mb-1"><i class="far fa-calendar-alt text-success"></i> ${formatDate(booking.CheckInDate)} <i class="fas fa-arrow-right small text-muted"></i> ${formatDate(booking.CheckOutDate)}</p>
                                    <p class="mb-0"><strong>Tổng tiền:</strong> <span class="text-danger h5 fw-bold">${booking.TotalAmount.toLocaleString()} VNĐ</span></p>
                                </div>
                                <div class="col-md-4 text-md-end mt-3 mt-md-0">
                                    <div class="mb-3">${getStatusBadge(booking.Status)}</div>
                                    <div class="btn-group">
                                        <a href="/Customer/Booking/Details/${booking.Id}" class="btn btn-outline-primary btn-sm">Chi tiết</a>

                                        ${(booking.Status === 'draft' || booking.Status === 'pending' || booking.Status === 'confirmed') ?
                        `<a href="/Customer/Booking/Payment/${booking.Id}" class="btn btn-success btn-sm">Thanh toán</a>` : ''}

                                        ${(booking.Status !== 'cancelled' && booking.Status !== 'completed' && booking.Status !== 'paid') ?
                        `<button class="btn btn-outline-danger btn-sm" onclick="confirmCancel(${booking.Id})">Hủy</button>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
            });
            $("#bookingsList").html(html);
        }

        function formatDate(dateString) {
            // Xử lý cả dạng /Date()/ và ISO
            var date;
            if (dateString.indexOf("/Date(") !== -1) {
                date = new Date(parseInt(dateString.replace(/\/Date\((-?\d+)\)\//, '$1')));
            } else {
                date = new Date(dateString);
            }
            return date.toLocaleDateString('vi-VN');
        }

        function getStatusBadge(status) {
            var badges = {
                'draft': '<span class="badge bg-secondary">Nháp</span>',
                'pending': '<span class="badge bg-warning text-dark">Chờ thanh toán</span>',
                'paid': '<span class="badge bg-success">Đã thanh toán</span>',
                'confirmed': '<span class="badge bg-info">Đã xác nhận (Trả sau)</span>',
                'cancelled': '<span class="badge bg-danger">Đã hủy</span>',
                'completed': '<span class="badge bg-primary">Hoàn thành</span>'
            };
            return badges[status] || '<span class="badge bg-secondary">' + status + '</span>';
        }

        function getBorderColor(status) {
            switch (status) {
                case 'paid': return 'border-success';
                case 'cancelled': return 'border-danger';
                case 'pending': return 'border-warning';
                default: return 'border-secondary';
            }
        }

        function confirmCancel(bookingId) {
            // Chuyển hướng sang trang Cancel để xem chi tiết phí phạt
            window.location.href = '/Customer/Booking/Cancel/' + bookingId;
        }
    </script>
}