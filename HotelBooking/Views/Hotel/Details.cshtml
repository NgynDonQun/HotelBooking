@{
    ViewBag.Title = "Chi tiết khách sạn";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div id="hotelDetails">
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
    </div>
</div>

<div class="mt-4">
    <ul class="nav nav-tabs nav-fill" id="hotelTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active fw-bold" id="rooms-tab" data-bs-toggle="tab" data-bs-target="#rooms" type="button">
                <i class="fas fa-bed"></i> Danh sách phòng
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link fw-bold" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews" type="button">
                <i class="fas fa-comments"></i> Đánh giá & Bình luận
            </button>
        </li>
    </ul>
    <div class="tab-content border border-top-0 p-3 bg-white" id="hotelTabsContent">
        <div class="tab-pane fade show active" id="rooms" role="tabpanel">
            <div id="hotelRooms" class="mt-3"></div>
        </div>
        <div class="tab-pane fade" id="reviews" role="tabpanel">
            <div id="hotelReviews" class="mt-3"></div>
        </div>
    </div>
</div>

@section scripts {
    <script>
    var hotelId = @ViewBag.HotelId;
    var isAuthenticated = '@Request.IsAuthenticated'.toLowerCase() === 'true';

    $(document).ready(function () {
        loadHotelDetails();
        loadHotelRooms();
        loadHotelReviews();
    });

    function loadHotelDetails() {
        $.ajax({
            type: "GET",
            url: '/Hotel/GetDetails/' + hotelId,
            success: function (response) {
                if (response.success) {
                    var hotel = response.data;
                    var stars = ''; for(let i=0; i<hotel.StarRating; i++) stars+='⭐';

                    var html = `
                    <div class="row">
                        <div class="col-md-8">
                            <h2 class="text-primary fw-bold">${hotel.Name}</h2>
                            <p class="h5 mb-2">${stars}</p>
                            <p class="text-muted"><i class="fas fa-map-marker-alt text-danger"></i> ${hotel.Address}, ${hotel.City}, ${hotel.Country}</p>
                        </div>
                    </div>`;

                    // Carousel Ảnh
                    if (hotel.Images && hotel.Images.length > 0) {
                        html += `<div id="hotelCarousel" class="carousel slide mb-4 rounded overflow-hidden shadow" data-bs-ride="carousel">
                                    <div class="carousel-inner">`;
                        hotel.Images.forEach(function(img, index) {
                            html += `<div class="carousel-item ${index === 0 ? 'active' : ''}">
                                        <img src="${img.Url}" class="d-block w-100" style="height: 450px; object-fit: cover;" alt="${img.AltText || 'Hotel Image'}">
                                     </div>`;
                        });
                        html += `   </div>
                                    <button class="carousel-control-prev" type="button" data-bs-target="#hotelCarousel" data-bs-slide="prev">
                                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                    </button>
                                    <button class="carousel-control-next" type="button" data-bs-target="#hotelCarousel" data-bs-slide="next">
                                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                    </button>
                                </div>`;
                    }

                    html += `<div class="card shadow-sm"><div class="card-body">
                                <h4 class="card-title">Giới thiệu</h4>
                                <p class="card-text">${hotel.Description || 'Chưa có mô tả chi tiết.'}</p>
                             </div></div>`;

                    $("#hotelDetails").html(html);
                } else {
                    $("#hotelDetails").html('<div class="alert alert-danger">Không tải được thông tin khách sạn.</div>');
                }
            }
        });
    }

    function loadHotelRooms() {
        $("#hotelRooms").html('<div class="text-center"><div class="spinner-border text-primary"></div></div>');

        $.ajax({
            type: "GET",
            url: '/Hotel/GetRooms/' + hotelId,
            success: function (response) {
                if (response.success && response.rooms.length > 0) {
                    var html = '<div class="row">';

                    response.rooms.forEach(function(room) {
                        // Xác định trạng thái phòng
                        var isAvailable = room.Status === 'Available';
                        var statusBadge = '';
                        var statusClass = '';

                        if (isAvailable) {
                            statusBadge = '<span class="badge bg-success">Còn trống</span>';
                            statusClass = 'border-success';
                        } else if (room.Status === 'Booked') {
                            statusBadge = '<span class="badge bg-warning text-dark">Đã đặt</span>';
                            statusClass = 'opacity-75'; // Làm mờ nhẹ
                        } else {
                            statusBadge = '<span class="badge bg-secondary">Đang sử dụng</span>';
                            statusClass = 'bg-light text-muted opacity-75'; // Làm mờ + xám
                        }

                        // Label Loại phòng
                        var typeLabel = room.Type === 'VIP' ? '<span class="badge bg-warning text-dark me-2">VIP</span>' : '<span class="badge bg-info text-dark me-2">Thường</span>';
                        var imgUrl = room.ImageUrl ? room.ImageUrl : '/Content/images/no-image.png';

                        html += `
                        <div class="col-md-6 mb-4">
                            <div class="card h-100 ${statusClass} shadow-sm">
                                <div class="row g-0 h-100">
                                    <div class="col-md-5">
                                        <img src="${imgUrl}" class="img-fluid rounded-start h-100" style="object-fit: cover; min-height: 200px;" alt="Room Image">
                                    </div>
                                    <div class="col-md-7">
                                        <div class="card-body d-flex flex-column h-100">
                                            <div class="d-flex justify-content-between mb-2">
                                                <h5 class="card-title mb-0">Phòng ${room.RoomNumber}</h5>
                                                ${statusBadge}
                                            </div>
                                            <div class="mb-2">${typeLabel}</div>

                                            <p class="card-text small mb-2">${room.Description || 'Mô tả đang cập nhật'}</p>

                                            <ul class="list-unstyled small text-muted mb-3">
                                                <li><i class="fas fa-user-friends"></i> Sức chứa: ${room.Capacity} người</li>
                                            </ul>

                                            <div class="mt-auto pt-2 border-top">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <span class="text-danger fw-bold h5 mb-0">${room.PricePerNight.toLocaleString()} ₫</span>
                                                        <small class="text-muted">/đêm</small>
                                                    </div>

                                                    ${isAvailable ?
                                                        (isAuthenticated ?
                                                            `<a href="/Customer/Booking/Create?roomId=${room.Id}&hotelId=${hotelId}" class="btn btn-sm btn-primary">Đặt ngay</a>` :
                                                            `<a href="/Account/Login?returnUrl=${window.location.pathname}" class="btn btn-sm btn-outline-primary">Đăng nhập</a>`
                                                        ) :
                                                        `<button class="btn btn-sm btn-secondary" disabled>Không khả dụng</button>`
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    });

                    html += '</div>';
                    $("#hotelRooms").html(html);
                } else {
                    $("#hotelRooms").html('<div class="alert alert-warning text-center">Khách sạn này hiện chưa có danh sách phòng.</div>');
                }
            }
        });
    }

    function loadHotelReviews() {
        $.ajax({
            type: "GET",
            url: '/Hotel/GetReviews/' + hotelId,
            success: function (response) {
                if (response.success) {
                    var html = '';
                    if (response.reviews && response.reviews.length > 0) {
                        var avg = response.avgRating.toFixed(1);
                        html += `
                        <div class="d-flex align-items-center mb-4 p-3 bg-light rounded">
                            <div class="display-4 fw-bold text-primary me-3">${avg}</div>
                            <div>
                                <div class="text-warning small">${'⭐'.repeat(Math.round(response.avgRating))}</div>
                                <div class="text-muted">Dựa trên ${response.reviews.length} đánh giá</div>
                            </div>
                        </div>`;

                        response.reviews.forEach(function(review) {
                            var date = new Date(review.CreatedAt).toLocaleDateString('vi-VN');
                            // Sao đánh giá
                            var stars = ''; for(let i=0; i<review.Rating; i++) stars += '<i class="fas fa-star text-warning"></i>';

                            html += `
                            <div class="card mb-3 border-0 shadow-sm">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <h6 class="fw-bold mb-0">${review.UserEmail}</h6>
                                        <small class="text-muted">${date}</small>
                                    </div>
                                    <div class="mb-2">${stars}</div>
                                    <h6 class="fw-bold small text-dark">${review.Title || ''}</h6>
                                    <p class="card-text text-secondary">${review.Content}</p>
                                </div>
                            </div>`;
                        });
                    } else {
                        html = '<div class="text-center text-muted py-4"><i class="far fa-comment-dots fa-3x mb-3"></i><p>Chưa có đánh giá nào cho khách sạn này.</p></div>';
                    }
                    $("#hotelReviews").html(html);
                }
            }
        });
    }
    </script>
}